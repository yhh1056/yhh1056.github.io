---
title:  "[Architecture] CQRS ê²‰í•¥ê¸° "
excerpt: ""
toc: true
toc_sticky: true

categories:
  - content
last_modified_at: 2022-08-30TO00:40:00+09:00
---

# CQRS ê²‰í•¥ê¸°

## ì–´ì©Œë‹¤ CQRS

ìš°ì•„í•œí…Œí¬ì½”ìŠ¤4ê¸° íŒ€ í”„ë¡œì íŠ¸ ì´ˆê¸° ë‹¹ì‹œ ì„¤ê³„ì— ê´€í•œ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ´ìŠµë‹ˆë‹¤. JPAë¥¼ ì‚¬ìš©í•˜ë˜ ê°„ì ‘ ì°¸ì¡°ë¥¼ ì‚¬ìš©í•˜ê³  ì¡°íšŒ ì¿¼ë¦¬ì™€ ëª…ë ¹ ì¿¼ë¦¬ë¥¼ ë¶„ë¦¬í•˜ìëŠ” ê²°ë¡ ì´ ë‚˜ì™”ìŠµë‹ˆë‹¤. ì•„ì§ ë‘ ê°œë…ì´ ìƒì†Œí•˜ì˜€ê³  ì¶”ì²œë°›ì€ ìë£Œë“¤ì„ ë³´ì•˜ìŠµë‹ˆë‹¤. ê·¸ì¤‘ í•˜ë‚˜ê°€ ìµœë²”ê· ë‹˜ì˜ CQRS ì•„ëŠ” ì²™í•˜ê¸°ì…ë‹ˆë‹¤.

[ìµœë²”ê· ë‹˜ì˜ CQRS ì•„ëŠ” ì²™í•˜ê¸°](https://www.youtube.com/watch?v=xf0kXMTFJm8)

ì•„ì§ CQRSë¥¼ ê¹Šê²Œ ì•„ëŠ” ìƒíƒœë„ ì•„ë‹ˆê³  ì¡°íšŒì™€ ëª…ë ¹ì„ ë¶„ë¦¬í•´ ë³¸ ê²½í—˜ìœ¼ë¡œ ì‘ì„±í•œ ê¸€ì…ë‹ˆë‹¤. ì´ëŸ° ê²½í—˜ì„ í•´ë´¤êµ¬ë‚˜ ì •ë„ë¡œë´ì£¼ì‹œë©´ ì¢‹ì„ ê²ƒ ê°™ì•„ìš”.

> ê°„ì ‘ ì°¸ì¡°ëŠ” ë­ì§€?
>

JPAì˜ ì—”í‹°í‹° ë§¤í•‘ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  ê°ì²´ì˜ idë§Œ ì°¸ì¡°í•˜ëŠ” ìƒíƒœë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. JPAë¥¼ í•™ìŠµí•œ ì €ë¡œì¨ëŠ” ì´í•´ê°€ ë˜ì§€ ì•ŠëŠ” ë‚´ìš©ì´ì—ˆì£ . â€˜*ì—”í‹°í‹° ë§¤í•‘ì„ ì‚¬ìš©í•´ì„œ ê°ì²´ë¥¼ ì°¸ì¡°í•˜ê³  í¸í•˜ê²Œ ê°œë°œí•˜ëŠ” ê²Œ ì•„ë‹Œê°€?*â€™ â€˜*ì—”í‹°í‹° ë§¤í•‘ì„ ì‚¬ìš©í•˜ëŠ” ê²Œ ê°ì²´ì§€í–¥ ì•„ë‹Œê°€?*â€™ë¼ëŠ” ìƒê°ì´ ë“¤ì—ˆìŠµë‹ˆë‹¤.

íŒ€ì—ì„  ê°„ì ‘ ì°¸ì¡°ë¡œ ë¨¼ì € ì„¤ê³„ë¥¼ í•˜ê³  ì—”í‹°í‹° ì°¸ì¡°ê°€ ë” í•„ìš”í•´ì§€ëŠ” ìƒí™©ì—ì„  ì§ì ‘ ì°¸ì¡°ë¥¼ í•˜ìëŠ” ê²°ë¡ ì´ ë‚˜ì™”ìŠµë‹ˆë‹¤. ìš°ì„  ê²½í—˜í•´ ë³´ì§€ ëª»í–ˆìœ¼ë¯€ë¡œ ê²½í—˜ì„ í•´ë³´ë©´ì„œ ì¥ë‹¨ì ì„ ëŠê»´ë³´ê³ ì í•´ë‹¹ ì œì•ˆì„ ë™ì˜í•˜ì˜€ìŠµë‹ˆë‹¤.

ì¶”í›„ ë•¡ì¿ (ìš°ì•„í•œí…Œí¬ì½”ìŠ¤4ê¸° íŒ€ í”„ë¡œì íŠ¸ ì„œë¹„ìŠ¤ ì´ë¦„) íŒ€ì€ ê°„ì ‘ ì°¸ì¡°ì˜ ë¶ˆí¸í•œ ì ì„ ëŠë¼ê³  ê°„ì ‘ ì°¸ì¡°ì™€ ì§ì ‘ ì°¸ì¡°ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•˜ë©´ì„œ ê°œë°œì„ ì§„í–‰í•˜ì˜€ìŠµë‹ˆë‹¤. ê°„ì ‘ ì°¸ì¡°ë¥¼ í•˜ê²Œ ë˜ë©´ì„œ **ë„ë©”ì¸ ê°„ì˜ ì˜ì¡´ì„±ì„ ëŠì–´ë‚¼ ìˆ˜ ìˆê³ ** **ì¡°íšŒ ì‹œ JPAì˜ ì—¬ëŸ¬ ë¬¸ì œë“¤ì„ ê³ ë¯¼í•˜ì§€ ì•Šê³ ** ì¡°íšŒí•  ìˆ˜ ìˆë‹¤ëŠ” ì ì„ ê²½í—˜í–ˆì–´ìš”. í•´ë‹¹ ê²½í—˜ì— ê´€í•´ ë”°ë¡œ í¬ìŠ¤íŒ…ì„ í•´ë³¼ê²Œìš”.

> CQRS íŒ¨í„´ì€ ë­ì§€?
>

**C**ommand and **Q**uery **R**esponsibility **S**egregationì˜ ì•½ìë¡œ ëª…ë ¹ê³¼ ì¡°íšŒì˜ ì±…ì„ ë¶„ë¦¬ë¥¼ ë§í•©ë‹ˆë‹¤. ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ í•˜ë‚˜ì˜ íŒ¨í„´ì´ì£ . ì£¼ë¬¸ì„ í•˜ê±°ë‚˜ ë³€ê²½, ì·¨ì†Œì™€ ê°™ì´ ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ” ì‘ì—…ì´ ëª…ë ¹ì´ê³  ì£¼ë¬¸ ì¡°íšŒê°™ì´ ìƒíƒœë¥¼ ë°˜í™˜í•˜ëŠ” ì‘ì—…ì´ ì¡°íšŒë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.

ì¦‰ **ëª…ë ¹ ì—­í• ì„ ìˆ˜í–‰í•˜ëŠ” êµ¬ì„±ìš”ì†Œì™€ ì¿¼ë¦¬ ì—­í• ì„ ìˆ˜í–‰í•˜ëŠ” êµ¬ì„±ìš”ì†Œë¥¼ ë‚˜ëˆ„ëŠ” ê²ƒ**ì„ ë§í•©ë‹ˆë‹¤.-

<img width="381" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-08-30 á„‹á…©á„’á…® 6 23 17" src="https://user-images.githubusercontent.com/58363663/187433210-f113127e-5ff1-41aa-8b10-de5da5a471e0.png">

> ë¶„ë¦¬í•˜ë©´ ë­ê°€ ì¢‹ì€ê°€ìš”?
>

CQRSë¥¼ ì•Œì•„ë³¼ìˆ˜ë¡ ì œê°€ ëª¨ë¥´ëŠ” ì˜ì—­ë§Œ ë‚˜ì˜¤ë”ë¼ê³ ìš”. ê·¸ë˜ì„œ ì œê°€ ëŠë‚€ ì¥ì ì— ëŒ€í•´ì„œ ì ì–´ë³´ë ¤ê³  í•©ë‹ˆë‹¤.

ë‹¨ìˆœí•œ ë¹„ì¦ˆë‹ˆìŠ¤ê°€ ì•„ë‹ˆë¼ë©´ ì¡°íšŒìš© ëª¨ë¸ê³¼ ëª…ë ¹í˜• ëª¨ë¸ì€ ë¹„ìŠ·í•˜ê¸° í˜ë“­ë‹ˆë‹¤. ëª…ë ¹í˜• ëª¨ë¸ì˜ ê²½ìš° í•œ ì˜ì—­ì˜ ë°ì´í„°ë¥¼ ì£¼ë¡œ ë‹¤ë£¨ì§€ë§Œ ì¿¼ë¦¬í˜• ëª¨ë¸ì˜ ê²½ìš° ì—¬ëŸ¬ ì˜ì—­ì˜ ë°ì´í„°ë¥¼ ë‹¤ë£¹ë‹ˆë‹¤. ì˜ˆì•½ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ ì¿ í°ê³¼ íšŒì›ì˜ ì •ë³´ë“¤ì„ ê°€ì ¸ì˜¤ëŠ” ìƒí™©ì²˜ëŸ¼ ë§ì´ì£ . ì¿¼ë¦¬ì˜ ê²½ìš° ë³€ê²½ë„ ìì£¼ ì¼ì–´ë‚©ë‹ˆë‹¤. í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ë©´ì„œ ì¡°íšŒ ìª½ì—ì„œ ìˆ˜ì •ë˜ëŠ” ì¼ì´ í›¨ì”¬ ë§ì•˜ìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ ëª…ë ¹ê³¼ ì¡°íšŒê°€ í•¨ê»˜ ìˆë‹¤ë©´ ì„œë¡œ ë‹¤ë¥¸ ì´ìœ ë¡œ ì½”ë“œê°€ ë³€ê²½ë˜ê³  ì´ëŠ” ì±…ì„ì˜ í¬ê¸°ê°€ ì ë‹¹í•˜ì§€ ì•Šë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. **ê°ì²´ì˜ ì±…ì„**ìœ¼ë¡œë§Œ ë°”ë¼ë´ë„ ì¿¼ë¦¬ì™€ ëª…ë ¹ì„ ë¶„ë¦¬í•˜ëŠ” ì´ìœ ê°€ ì¶©ë¶„í•˜ë‹¤ê³  ìƒê°í–ˆìŠµë‹ˆë‹¤.

ì¡°ê¸ˆ ë” ë‚˜ì•„ê°€ë©´ ì¡°íšŒìš© ë°ì´í„°ë² ì´ìŠ¤ë¡œ ë¶„ë¦¬í•  ìˆ˜ ìˆê³  ìƒí™©ì— ë§ê²Œ íŠœë‹ì„ í•  ìˆ˜ ìˆëŠ” ì´ì ì´ ìƒê¹ë‹ˆë‹¤. ì´ë²¤íŠ¸ ì†Œì‹±ì— ëŒ€í•´ì„œëŠ” ëª¨ë¥´ê² ìŠµë‹ˆë‹¤. ğŸ˜‚

í•œ ê°€ì§€ ë” ëŠë‚€ ì¥ì ìœ¼ë¡œëŠ” ì˜ˆì•½ or ë¯¸íŒ… â†’ ì¿ í° â†’ íšŒì›ìœ¼ë¡œ ë°©í–¥ì´ í˜ëŸ¬ê°€ëŠ” ë•¡ì¿ ì˜ í”„ë¡œì íŠ¸ì—ì„œ ì˜ˆì•½ì´ë‚˜ ë¯¸íŒ…ì—ì„œ íšŒì›ê¹Œì§€ ì¡°íšŒí•´ì˜¬ ê²½ìš° JPAì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì—¬ëŸ¬ ë¬¸ì œì ë“¤ì„ ê³ ë ¤í•˜ì§€ ì•Šê³  jdbcë¥¼ í†µí•´ ë¹„êµì  í•™ìŠµê³¡ì„  ì—†ì´ ê°œë°œì„ í•  ìˆ˜ ìˆì—ˆì–´ìš”. JPA ê´€ë ¨ ê¸°ìˆ ì´ í•„ìš”í•´ì§„ë‹¤ë©´ ê·¸ë•Œ ì „í™˜í•˜ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.

---

## ì½”ë“œ ì‚´ì§ ë§›ë³´ê¸°

ëª…ë ¹ê³¼ ê´€ë ¨ëœ ë¡œì§ì€ CouponServiceì—ì„œ ìˆ˜í–‰í•˜ê³  `@Transactional` ì–´ë…¸í…Œì´ì…˜ì„ í´ë˜ìŠ¤ ë‹¨ê³„ì— ì‚¬ìš©í•˜ì—¬ ìƒíƒœë¥¼ ë³€í™”ì‹œí‚¤ëŠ” ì±…ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

```java
@Service
@Transactional
@RequiredArgsConstructor
public class CouponService {      // Coupon Command Service

    private final CouponRepository couponRepository;
    private final MemberRepository memberRepository;
    private final AlarmSender alarmSender;

		// ì¿ í° ì „ì²´ ì €ì¥
    public void saveAll(final Long senderId, final CouponRequest couponRequest) {
        validateMember(senderId, couponRequest.getReceiverIds());
        Coupons coupons = new Coupons(couponRepository.saveAll(couponRequest.toEntities(senderId)));
        Members members = new Members(memberRepository.findByIdIn(coupons.getReceiverIds()));
        sendMessage(senderId, members.getEmails(), couponRequest.toCouponContent());
    }

		...
}
```

ì¿¼ë¦¬ì™€ ê´€ë ¨ëœ ë¡œì§ì€ CouponQueryServiceì—ì„œ ìˆ˜í–‰í•˜ê³  `@Transactional(readOnly = true)` ì–´ë…¸í…Œì´ì…˜ì„ í´ë˜ìŠ¤ë‹¨ê³„ì— ì‚¬ìš©í•˜ì—¬ ìƒíƒœë¥¼ ë°˜í™˜í•˜ëŠ” ì±…ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

```java
@Service
@Transactional(readOnly = true)
@RequiredArgsConstructor
public class CouponQueryService {     // Coupon Query Service

    private final CouponQueryRepository couponQueryRepository;
    private final ReservationProvider reservationProvider;
    private final MeetingProvider meetingProvider;

		// ë°›ì€ ì¿ í° ì¡°íšŒ
    public List<CouponResponse> getReceivedCoupons(final Long receiverId, final String status) {
        List<String> statusNames = CouponStatusGroup.findStatusNames(status);
        return couponQueryRepository.findByReceiverIdAndStatus(receiverId, statusNames)
                .stream()
                .map(CouponResponse::of)
                .collect(Collectors.toList());
    }

		// ë³´ë‚¸ ì¿ í° ì¡°íšŒ
    public List<CouponResponse> getSentCoupons(final Long senderId) {
        return couponQueryRepository.findBySenderId(senderId)
                .stream()
                .map(CouponResponse::of)
                .collect(Collectors.toList());
    }

		// ì¿ í° ìƒì„¸ ì¡°íšŒ
    public CouponDetailResponse getCouponDetail(final Long memberId, final Long couponId) {
        MemberCoupon memberCoupon = getMemberCoupon(couponId);
        validateCouponOwner(memberId, memberCoupon);

        CouponStatus couponStatus = CouponStatus.of(memberCoupon.getStatus());
        if (couponStatus.isInReserveOrUsed()) {
            return getCouponDetailResponse(couponId, memberCoupon, couponStatus);
        }
        return CouponDetailResponse.of(memberCoupon);
    }
		...
}
```

ì „ì²´ì½”ë“œëŠ” https://github.com/woowacourse-teams/2022-thankoo ì—¬ê¸°ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ê²°ë¡ 

ì‚¬ì‹¤ í˜„ì¬ í”„ë¡œì íŠ¸ ê·œëª¨ì—ì„œ CQRS íŒ¨í„´ì„ ë„ì…í•œë‹¤ëŠ” ê²ƒì´ í° ì˜ë¯¸ê°€ ìˆì§€ëŠ” ì•Šì•„ ë³´ì…ë‹ˆë‹¤. CQRSì˜ ëœ» ê·¸ëŒ€ë¡œ ì–´í”Œë¦¬ì¼€ì´ì…˜ ì˜ì—­ì˜ ëª…ë ¹ê³¼ ì¿¼ë¦¬ì˜ ì±…ì„ì„ ë¶„ë¦¬í–ˆë‹¤ ì •ë„ë¡œ ì–˜ê¸°í•  ìˆ˜ ìˆê² ë„¤ìš”. ì¶”í›„ ê·œëª¨ê°€ ë” ì»¤ì§€ê²Œ ëœë‹¤ë©´ ì§€ê¸ˆ ë¶„ë¦¬í•´ë‘” ì´ ì‘ì—…ì€ ë” ìœ ì˜ë¯¸í•´ì§ˆ ê²ƒ ê°™ì•„ìš”. ë¶„ë¦¬í–ˆë‹¤ê³  í•´ì„œ ëŠë‚€ ë‹¨ì ì€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤. í•™ìŠµì„ ì´ì–´ë‚˜ê°€ë©´ì„œ ë” ê¹Šì´ìˆëŠ” ì§€ì‹ìœ¼ë¡œ í¬ìŠ¤íŒ…ì„ ì´ì–´ë‚˜ê°€ê² ìŠµë‹ˆë‹¤.

---

ì°¸ê³  : https://bluayer.com/37